# EduLearn Makefile
# A comprehensive build and deployment system for the EduLearn application

.PHONY: help install dev prod down clean build test lint format db-init db-reset db-backup db-restore deploy logs status health check-env

# Default target
help: ## Show this help message
	@echo "ğŸš€ EduLearn Development & Deployment Commands"
	@echo "=============================================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ“‹ Quick Start:"
	@echo "  make install    # Install dependencies"
	@echo "  make dev        # Start development environment"
	@echo "  make prod       # Start production environment"
	@echo "  make down       # Stop all containers"
	@echo ""

# Environment setup
install: ## Install project dependencies
	@echo "ğŸ“¦ Installing dependencies..."
	npm install
	@echo "âœ… Dependencies installed successfully"

check-env: ## Check if .env file exists and create from template if needed
	@if [ ! -f .env ]; then \
		echo "ğŸ“ Creating .env file from template..."; \
		cp env.example .env; \
		echo "âœ… .env file created. Please update it with your configuration."; \
	else \
		echo "âœ… .env file already exists"; \
	fi

# Development commands
dev: check-env ## Start development environment with Docker
	@echo "ğŸ³ Starting development environment..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "â³ Waiting for services to be ready..."
	@sleep 10
	@echo "ğŸ” Checking service status..."
	@make health
	@echo ""
	@echo "ğŸ‰ Development environment is ready!"
	@echo "ğŸ“± Access your application:"
	@echo "   - Main App: http://localhost:3000"
	@echo "   - Database Admin: http://localhost:5050 (admin@edulearn.com / admin123)"
	@echo ""

dev-build: check-env ## Build and start development environment
	@echo "ğŸ”¨ Building development environment..."
	docker-compose -f docker-compose.dev.yml up -d --build
	@echo "â³ Waiting for services to be ready..."
	@sleep 15
	@make health

dev-logs: ## Show development environment logs
	docker-compose -f docker-compose.dev.yml logs -f

dev-down: ## Stop development environment
	@echo "ğŸ›‘ Stopping development environment..."
	docker-compose -f docker-compose.dev.yml down
	@echo "âœ… Development environment stopped"

# Production commands
prod: check-env ## Start production environment with Docker
	@echo "ğŸš€ Starting production environment..."
	docker-compose up -d
	@echo "â³ Waiting for services to be ready..."
	@sleep 15
	@make health
	@echo ""
	@echo "ğŸ‰ Production environment is ready!"
	@echo "ğŸ“± Access your application: http://localhost:3000"

prod-build: check-env ## Build and start production environment
	@echo "ğŸ”¨ Building production environment..."
	docker-compose up -d --build
	@echo "â³ Waiting for services to be ready..."
	@sleep 20
	@make health

prod-logs: ## Show production environment logs
	docker-compose logs -f

prod-down: ## Stop production environment
	@echo "ğŸ›‘ Stopping production environment..."
	docker-compose down
	@echo "âœ… Production environment stopped"

# General Docker commands
down: ## Stop all containers (both dev and prod)
	@echo "ğŸ›‘ Stopping all containers..."
	docker-compose -f docker-compose.dev.yml down 2>/dev/null || true
	docker-compose down 2>/dev/null || true
	@echo "âœ… All containers stopped"

clean: ## Remove all containers, images, and volumes
	@echo "ğŸ§¹ Cleaning up Docker resources..."
	docker-compose -f docker-compose.dev.yml down -v --rmi all 2>/dev/null || true
	docker-compose down -v --rmi all 2>/dev/null || true
	docker system prune -f
	@echo "âœ… Cleanup completed"

build: ## Build Docker image
	@echo "ğŸ”¨ Building Docker image..."
	docker build -t edulearn .
	@echo "âœ… Docker image built successfully"

# Database commands
db-init: ## Initialize database schema and seed data
	@echo "ğŸ—„ï¸ Initializing database..."
	@if docker ps | grep -q edulearn-postgres; then \
		echo "Database container is running, initializing..."; \
		curl -X POST http://localhost:3000/api/init-database || echo "API endpoint not available, using direct database connection"; \
	else \
		echo "âŒ Database container is not running. Start the environment first with 'make dev' or 'make prod'"; \
	fi

db-reset: ## Reset database (WARNING: This will delete all data)
	@echo "âš ï¸  WARNING: This will delete all database data!"
	@read -p "Are you sure? Type 'yes' to continue: " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		echo "ğŸ—„ï¸ Resetting database..."; \
		docker-compose -f docker-compose.dev.yml down -v 2>/dev/null || true; \
		docker-compose down -v 2>/dev/null || true; \
		echo "âœ… Database reset completed. Run 'make dev' or 'make prod' to restart."; \
	else \
		echo "âŒ Database reset cancelled."; \
	fi

db-backup: ## Create database backup
	@echo "ğŸ’¾ Creating database backup..."
	@if docker ps | grep -q edulearn-postgres; then \
		docker exec edulearn-postgres pg_dump -U edulearn_user edulearn > backup_$$(date +%Y%m%d_%H%M%S).sql; \
		echo "âœ… Database backup created: backup_$$(date +%Y%m%d_%H%M%S).sql"; \
	else \
		echo "âŒ Database container is not running"; \
	fi

db-restore: ## Restore database from backup file
	@echo "ğŸ“¥ Restoring database from backup..."
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "âŒ Please specify backup file: make db-restore BACKUP_FILE=backup_20231201_120000.sql"; \
	else \
		if docker ps | grep -q edulearn-postgres; then \
			docker exec -i edulearn-postgres psql -U edulearn_user edulearn < $(BACKUP_FILE); \
			echo "âœ… Database restored from $(BACKUP_FILE)"; \
		else \
			echo "âŒ Database container is not running"; \
		fi \
	fi

# Testing and quality
test: ## Run tests
	@echo "ğŸ§ª Running tests..."
	npm test

lint: ## Run ESLint
	@echo "ğŸ” Running ESLint..."
	npm run lint

format: ## Format code with Prettier
	@echo "âœ¨ Formatting code..."
	npx prettier --write "src/**/*.{ts,tsx,js,jsx,json,css,md}"

# Monitoring and status
logs: ## Show logs from all containers
	@echo "ğŸ“‹ Showing logs from all containers..."
	docker-compose -f docker-compose.dev.yml logs -f 2>/dev/null || docker-compose logs -f

status: ## Show status of all containers
	@echo "ğŸ“Š Container Status:"
	@echo "==================="
	docker-compose -f docker-compose.dev.yml ps 2>/dev/null || docker-compose ps

health: ## Check health of all services
	@echo "ğŸ¥ Health Check:"
	@echo "==============="
	@if docker ps | grep -q edulearn-postgres; then \
		if docker exec edulearn-postgres pg_isready -U edulearn_user -d edulearn >/dev/null 2>&1; then \
			echo "âœ… PostgreSQL: Healthy"; \
		else \
			echo "âŒ PostgreSQL: Unhealthy"; \
		fi \
	else \
		echo "âŒ PostgreSQL: Not running"; \
	fi
	@if docker ps | grep -q edulearn-redis; then \
		if docker exec edulearn-redis redis-cli ping >/dev/null 2>&1; then \
			echo "âœ… Redis: Healthy"; \
		else \
			echo "âŒ Redis: Unhealthy"; \
		fi \
	else \
		echo "âŒ Redis: Not running"; \
	fi
	@if curl -s http://localhost:3000/api/health >/dev/null 2>&1; then \
		echo "âœ… Application: Healthy"; \
	else \
		echo "âŒ Application: Not responding"; \
	fi

# Deployment commands
deploy: ## Deploy to Vercel (requires Vercel CLI)
	@echo "ğŸš€ Deploying to Vercel..."
	@if command -v vercel >/dev/null 2>&1; then \
		vercel --prod; \
	else \
		echo "âŒ Vercel CLI not found. Install with: npm i -g vercel"; \
	fi

deploy-dev: ## Deploy to Vercel (development)
	@echo "ğŸš€ Deploying to Vercel (development)..."
	@if command -v vercel >/dev/null 2>&1; then \
		vercel; \
	else \
		echo "âŒ Vercel CLI not found. Install with: npm i -g vercel"; \
	fi

# Utility commands
shell: ## Open shell in application container
	@echo "ğŸš Opening shell in application container..."
	@if docker ps | grep -q edulearn-app; then \
		docker exec -it edulearn-app sh; \
	elif docker ps | grep -q edulearn-app-dev; then \
		docker exec -it edulearn-app-dev sh; \
	else \
		echo "âŒ Application container is not running"; \
	fi

db-shell: ## Open PostgreSQL shell
	@echo "ğŸš Opening PostgreSQL shell..."
	@if docker ps | grep -q edulearn-postgres; then \
		docker exec -it edulearn-postgres psql -U edulearn_user -d edulearn; \
	elif docker ps | grep -q edulearn-postgres-dev; then \
		docker exec -it edulearn-postgres-dev psql -U edulearn_user -d edulearn_dev; \
	else \
		echo "âŒ PostgreSQL container is not running"; \
	fi

redis-cli: ## Open Redis CLI
	@echo "ğŸš Opening Redis CLI..."
	@if docker ps | grep -q edulearn-redis; then \
		docker exec -it edulearn-redis redis-cli; \
	elif docker ps | grep -q edulearn-redis-dev; then \
		docker exec -it edulearn-redis-dev redis-cli; \
	else \
		echo "âŒ Redis container is not running"; \
	fi

# Quick commands
start: dev ## Alias for dev
stop: down ## Alias for down
restart: down dev ## Restart development environment
restart-prod: prod-down prod ## Restart production environment

# Windows compatibility (if using Git Bash or similar)
win-dev: ## Windows-compatible development start
	@echo "ğŸ³ Starting development environment (Windows)..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "â³ Waiting for services to be ready..."
	@timeout /t 10 /nobreak >nul 2>&1 || sleep 10
	@echo "ğŸ” Checking service status..."
	@make health

win-prod: ## Windows-compatible production start
	@echo "ğŸš€ Starting production environment (Windows)..."
	docker-compose up -d
	@echo "â³ Waiting for services to be ready..."
	@timeout /t 15 /nobreak >nul 2>&1 || sleep 15
	@make health
